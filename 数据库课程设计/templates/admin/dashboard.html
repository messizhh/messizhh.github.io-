{% extends "base.html" %}

{% block title %}管理员面板{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/1.7.0/css/buttons.dataTables.min.css">
<script src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.js"></script>
<script src="https://cdn.datatables.net/buttons/1.7.0/js/dataTables.buttons.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/1.7.0/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/1.7.0/js/buttons.print.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-md-12">
            <h2>管理员面板</h2>
        </div>
    </div>

    <!-- 导航标签 -->
    <ul class="nav nav-tabs" id="adminTabs" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="classes-tab" data-toggle="tab" href="#classes" role="tab">班级管理</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="majors-tab" data-toggle="tab" href="#majors" role="tab">专业管理</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="teachers-tab" data-toggle="tab" href="#teachers" role="tab">教师管理</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="courses-tab" data-toggle="tab" href="#courses" role="tab">课程管理</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="semesters-tab" data-toggle="tab" href="#semesters" role="tab">学期管理</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="reports-tab" data-toggle="tab" href="#reports" role="tab">报表管理</a>
        </li>
    </ul>

    <!-- 标签内容 -->
    <div class="tab-content" id="adminTabContent">
        <!-- 班级管理 -->
        <div class="tab-pane fade show active" id="classes" role="tabpanel">
            <div class="card mt-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">班级列表</h5>
                    <button class="btn btn-primary" data-toggle="modal" data-target="#addClassModal">
                        添加班级
                    </button>
                </div>
                <div class="card-body">
                    <table class="table" id="classesTable">
                        <thead>
                            <tr>
                                <th>班级编号</th>
                                <th>班级名称</th>
                                <th>专业</th>
                                <th>辅导员</th>
                                <th>学生人数</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </div>

        <!-- 专业管理 -->
        <div class="tab-pane fade" id="majors" role="tabpanel">
            <div class="card mt-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">专业列表</h5>
                    <button class="btn btn-primary" data-toggle="modal" data-target="#addMajorModal">
                        添加专业
                    </button>
                </div>
                <div class="card-body">
                    <table class="table" id="majorsTable">
                        <thead>
                            <tr>
                                <th>专业编号</th>
                                <th>专业名称</th>
                                <th>所属院系</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </div>

        <!-- 教师管理 -->
        <div class="tab-pane fade" id="teachers" role="tabpanel">
            <div class="card mt-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">教师列表</h5>
                    <button class="btn btn-primary" data-toggle="modal" data-target="#addTeacherModal">
                        添加教师
                    </button>
                </div>
                <div class="card-body">
                    <table class="table" id="teachersTable">
                        <thead>
                            <tr>
                                <th>工号</th>
                                <th>姓名</th>
                                <th>职称</th>
                                <th>所属院系</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </div>

        <!-- 课程管理 -->
        <div class="tab-pane fade" id="courses" role="tabpanel">
            <div class="card mt-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">课程列表</h5>
                    <button class="btn btn-primary" data-toggle="modal" data-target="#addCourseModal">
                        添加课程
                    </button>
                </div>
                <div class="card-body">
                    <table class="table" id="coursesTable">
                        <thead>
                            <tr>
                                <th>课程编号</th>
                                <th>课程名称</th>
                                <th>学分</th>
                                <th>课时</th>
                                <th>授课教师</th>
                                <th>学期</th>
                                <th>最大人数</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </div>

        <!-- 学期管理 -->
        <div class="tab-pane fade" id="semesters" role="tabpanel">
            <div class="card mt-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">学期列表</h5>
                    <button class="btn btn-primary" data-toggle="modal" data-target="#addSemesterModal">
                        添加学期
                    </button>
                </div>
                <div class="card-body">
                    <table class="table" id="semestersTable">
                        <thead>
                            <tr>
                                <th>学期编号</th>
                                <th>学期名称</th>
                                <th>开始日期</th>
                                <th>结束日期</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </div>

        <!-- 报表管理 -->
        <div class="tab-pane fade" id="reports" role="tabpanel">
            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="mb-0">统计报表</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    教师工作量统计
                                    <button class="btn btn-sm btn-primary float-right" id="exportTeacherWorkload">
                                        导出报表
                                    </button>
                                </div>
                                <div class="card-body">
                                    <canvas id="teacherWorkloadChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    选课情况统计
                                    <button class="btn btn-sm btn-primary float-right" id="exportCourseSelection">
                                        导出报表
                                    </button>
                                </div>
                                <div class="card-body">
                                    <canvas id="courseSelectionChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 查看学生模态框 -->
<div class="modal fade" id="viewStudentsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">班级学生列表</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <table class="table" id="studentsTable">
                    <thead>
                        <tr>
                            <th>学号</th>
                            <th>姓名</th>
                            <th>性别</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<!-- 编辑班级模态框 -->
<div class="modal fade" id="editClassModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">编辑班级</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editClassForm">
                    <input type="hidden" id="edit_class_id">
                    <div class="form-group">
                        <label>班级名称</label>
                        <input type="text" class="form-control" id="edit_class_name" required>
                    </div>
                    <div class="form-group">
                        <label>所属专业</label>
                        <select class="form-control" id="edit_class_major" required>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>辅导员</label>
                        <select class="form-control" id="edit_class_counselor">
                            <option value="">未分配</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="updateClass()">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 添加班级模态框 -->
<div class="modal fade" id="addClassModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">添加班级</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="addClassForm">
                    <div class="form-group">
                        <label>班级名称</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="form-group">
                        <label>所属专业</label>
                        <select class="form-control" name="majorId" id="majorId" required>
                            <option value="">选择专业...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>辅导员</label>
                        <select class="form-control" name="counselorId" id="counselorId">
                            <option value="">选择辅导员...</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="window.addClass()">添加</button>
            </div>
        </div>
    </div>
</div>

<!-- 添加专业模态框 -->
<div class="modal fade" id="addMajorModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">添加专业</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="addMajorForm">
                    <div class="form-group">
                        <label>专业名称</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="form-group">
                        <label>所属院系</label>
                        <input type="text" class="form-control" name="department" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="window.addMajor()">添加</button>
            </div>
        </div>
    </div>
</div>

<!-- 编辑专业模态框 -->
<div class="modal fade" id="editMajorModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">编辑专业</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editMajorForm">
                    <input type="hidden" id="edit_major_id">
                    <div class="form-group">
                        <label>专业名称</label>
                        <input type="text" class="form-control" id="edit_major_name" required>
                    </div>
                    <div class="form-group">
                        <label>所属院系</label>
                        <input type="text" class="form-control" id="edit_major_department" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="window.updateMajor()">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 添加教师模态框 -->
<div class="modal fade" id="addTeacherModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">添加教师</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="addTeacherForm">
                    <div class="form-group">
                        <label>姓名</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="form-group">
                        <label>职称</label>
                        <select class="form-control" name="title" required>
                            <option value="教授">教授</option>
                            <option value="副教授">副教授</option>
                            <option value="讲师">讲师</option>
                            <option value="助教">助教</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>所属院系</label>
                        <input type="text" class="form-control" name="department" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="window.addTeacher()">添加</button>
            </div>
        </div>
    </div>
</div>

<!-- 编辑教师模态框 -->
<div class="modal fade" id="editTeacherModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">编辑教师</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editTeacherForm">
                    <input type="hidden" id="edit_teacher_id">
                    <div class="form-group">
                        <label>姓名</label>
                        <input type="text" class="form-control" id="edit_teacher_name" required>
                    </div>
                    <div class="form-group">
                        <label>职称</label>
                        <select class="form-control" id="edit_teacher_title" required>
                            <option value="教授">教授</option>
                            <option value="副教授">副教授</option>
                            <option value="讲师">讲师</option>
                            <option value="助教">助教</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>所属院系</label>
                        <input type="text" class="form-control" id="edit_teacher_department" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="window.updateTeacher()">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 编辑课程模态框 -->
<div class="modal fade" id="editCourseModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">编辑课程</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editCourseForm">
                    <input type="hidden" id="edit_course_id">
                    <div class="form-group">
                        <label>课程名称</label>
                        <input type="text" class="form-control" id="edit_course_name" required>
                    </div>
                    <div class="form-group">
                        <label>学分</label>
                        <input type="number" class="form-control" id="edit_course_credits" required>
                    </div>
                    <div class="form-group">
                        <label>课时</label>
                        <input type="number" class="form-control" id="edit_course_hours" required>
                    </div>
                    <div class="form-group">
                        <label>授课教师</label>
                        <select class="form-control" id="edit_course_teacher" required>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>学期</label>
                        <select class="form-control" id="edit_course_semester" required>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>最大人数</label>
                        <input type="number" class="form-control" id="edit_course_max_students" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="window.updateCourse()">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 添加课程模态框 -->
<div class="modal fade" id="addCourseModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">添加课程</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="addCourseForm">
                    <div class="form-group">
                        <label>课程名称</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="form-group">
                        <label>学分</label>
                        <input type="number" class="form-control" name="credits" required>
                    </div>
                    <div class="form-group">
                        <label>课时</label>
                        <input type="number" class="form-control" name="hours" required>
                    </div>
                    <div class="form-group">
                        <label>授课教师</label>
                        <select class="form-control" name="teacher_id" required>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>学期</label>
                        <select class="form-control" name="semester_id" required>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>最大人数</label>
                        <input type="number" class="form-control" name="max_students" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="window.addCourse()">添加</button>
            </div>
        </div>
    </div>
</div>

<!-- 编辑学期模态框 -->
<div class="modal fade" id="editSemesterModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">编辑学期</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editSemesterForm">
                    <input type="hidden" id="edit_semester_id">
                    <div class="form-group">
                        <label>学期名称</label>
                        <input type="text" class="form-control" id="edit_semester_name" required>
                    </div>
                    <div class="form-group">
                        <label>开始日期</label>
                        <input type="date" class="form-control" id="edit_semester_start_date" required>
                    </div>
                    <div class="form-group">
                        <label>结束日期</label>
                        <input type="date" class="form-control" id="edit_semester_end_date" required>
                    </div>
                    <div class="form-group">
                        <div class="custom-control custom-switch">
                            <input type="checkbox" class="custom-control-input" id="edit_semester_status">
                            <label class="custom-control-label" for="edit_semester_status">当前学期</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="window.updateSemester()">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 添加学期模态框 -->
<div class="modal fade" id="addSemesterModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">添加学期</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="addSemesterForm">
                    <div class="form-group">
                        <label>学期名称</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="form-group">
                        <label>开始日期</label>
                        <input type="date" class="form-control" name="start_date" required>
                    </div>
                    <div class="form-group">
                        <label>结束日期</label>
                        <input type="date" class="form-control" name="end_date" required>
                    </div>
                    <div class="form-group">
                        <div class="custom-control custom-switch">
                            <input type="checkbox" class="custom-control-input" name="status" id="add_semester_status">
                            <label class="custom-control-label" for="add_semester_status">当前学期</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="window.addSemester()">添加</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // 初始化表格对象
    window.tables = {
        // 班级表格
        classesTable: $('#classesTable').DataTable({
            ajax: {
                url: '/api/admin/classes/list',
                dataSrc: ''
            },
            columns: [
                { data: '0' },  // class_id
                { data: '1' },  // name
                { data: '2' },  // major_name
                {
                    data: '3',  // counselor_name
                    render: function(data) {
                        return data || '未分配';
                    }
                },
                { data: '4' },  // student_count
                {
                    data: null,
                    render: function(data, type, row) {
                        return `
                            <button type="button" class="btn btn-sm btn-info" onclick="window.viewClassStudents(${row[0]})">查看学生</button>
                            <button type="button" class="btn btn-sm btn-warning" onclick="window.editClass(${row[0]})">编辑</button>
                            <button type="button" class="btn btn-sm btn-danger" onclick="window.deleteClass(${row[0]})">删除</button>
                        `;
                    }
                }
            ],
            language: {
                url: '//cdn.datatables.net/plug-ins/1.10.21/i18n/Chinese.json'
            }
        }),
        // 专业表格
        majorsTable: $('#majorsTable').DataTable({
            ajax: {
                url: '/api/admin/majors/list',
                dataSrc: ''
            },
            columns: [
                { data: '0' },  // major_id
                { data: '1' },  // name
                { data: '2' },  // department
                {
                    data: null,
                    render: function(data, type, row) {
                        return `
                            <button type="button" class="btn btn-sm btn-warning" onclick="window.editMajor(${row[0]})">编辑</button>
                            <button type="button" class="btn btn-sm btn-danger" onclick="window.deleteMajor(${row[0]})">删除</button>
                        `;
                    }
                }
            ],
            language: {
                url: '//cdn.datatables.net/plug-ins/1.10.21/i18n/Chinese.json'
            }
        }),
        // 教师表格
        teachersTable: $('#teachersTable').DataTable({
            ajax: {
                url: '/api/admin/teachers/list',
                dataSrc: ''
            },
            columns: [
                { data: '0' },  // teacher_id
                { data: '1' },  // name
                { data: '2' },  // title
                { data: '3' },  // department
                {
                    data: null,
                    render: function(data, type, row) {
                        return `
                            <button type="button" class="btn btn-sm btn-warning" onclick="window.editTeacher('${row[0]}')">编辑</button>
                            <button type="button" class="btn btn-sm btn-danger" onclick="window.deleteTeacher('${row[0]}')">删除</button>
                        `;
                    }
                }
            ],
            language: {
                url: '//cdn.datatables.net/plug-ins/1.10.21/i18n/Chinese.json'
            }
        }),
        // 课程表格
        coursesTable: $('#coursesTable').DataTable({
            ajax: {
                url: '/api/admin/courses/list',
                dataSrc: ''
            },
            columns: [
                { data: '0' },  // course_id
                { data: '1' },  // name
                { data: '2' },  // credits
                { data: '3' },  // hours
                { data: '4' },  // teacher_name
                { data: '5' },  // semester_name
                { data: '6' },  // max_students
                {
                    data: null,
                    render: function(data, type, row) {
                        return `
                            <button type="button" class="btn btn-sm btn-warning" onclick="window.editCourse('${row[0]}')">编辑</button>
                            <button type="button" class="btn btn-sm btn-danger" onclick="window.deleteCourse('${row[0]}')">删除</button>
                        `;
                    }
                }
            ],
            language: {
                url: '//cdn.datatables.net/plug-ins/1.10.21/i18n/Chinese.json'
            }
        }),
        // 学期表格
        semestersTable: $('#semestersTable').DataTable({
            ajax: {
                url: '/api/admin/semesters/list',
                dataSrc: ''
            },
            columns: [
                { data: 'semester_id' },
                { data: 'name' },
                { data: 'start_date' },
                { data: 'end_date' },
                {
                    data: 'status',
                    render: function(data) {
                        return data === 1 ? '当前学期' : '非当前学期';
                    }
                },
                {
                    data: null,
                    render: function(data, type, row) {
                        return `
                            <button type="button" class="btn btn-sm btn-warning" onclick="window.editSemester(${row.semester_id})">编辑</button>
                            <button type="button" class="btn btn-sm btn-danger" onclick="window.deleteSemester(${row.semester_id})">删除</button>
                        `;
                    }
                }
            ],
            language: {
                url: '//cdn.datatables.net/plug-ins/1.10.21/i18n/Chinese.json'
            }
        })
    };

    // 将函数绑定到 window 对象
    window.editClass = function(classId) {
        console.log('Editing class:', classId);

        $.get(`/api/admin/classes/${classId}`, function(classData) {
            console.log('Class data:', classData);

            $('#edit_class_id').val(classId);
            $('#edit_class_name').val(classData.name);

            $.get('/api/admin/majors/list', function(majors) {
                $('#edit_class_major').empty();
                majors.forEach(major => {
                    $('#edit_class_major').append(
                        $('<option>')
                            .val(major[0])
                            .text(major[1])
                            .prop('selected', major[0] === classData.major_id)
                    );
                });
            });

            $.get('/api/admin/counselors/list', function(counselors) {
                $('#edit_class_counselor').empty();
                $('#edit_class_counselor').append(
                    $('<option>')
                        .val('')
                        .text('未分配')
                        .prop('selected', !classData.counselor_id)
                );
                counselors.forEach(counselor => {
                    $('#edit_class_counselor').append(
                        $('<option>')
                            .val(counselor[0])
                            .text(counselor[1])
                            .prop('selected', counselor[0] === classData.counselor_id)
                    );
                });
            });

            $('#editClassModal').modal('show');
        });
    };

    window.deleteClass = function(classId) {
        if (confirm('确定要删除这个班级吗？')) {
            $.ajax({
                url: `/api/admin/classes/${classId}`,
                method: 'DELETE',
                success: function() {
                    showAlert('success', '删除班级成功');
                    tables.classesTable.ajax.reload();
                },
                error: function(xhr) {
                    showAlert('danger', '删除班级失败: ' + (xhr.responseJSON?.error || '未知错误'));
                }
            });
        }
    };

    window.viewClassStudents = function(classId) {
        console.log('Viewing students for class:', classId);
        try {
            const $modal = $('#viewStudentsModal');
            console.log('Modal element:', $modal.length ? 'found' : 'not found');
            console.log('Modal jQuery object:', $modal);
            console.log('Bootstrap modal function:', typeof $modal.modal);

            $modal.modal('show');

            $.get(`/api/admin/classes/${classId}/students`)
                .done(function(students) {
                    console.log('Students data received:', students);
                    const tbody = $('#studentsTable tbody');
                    console.log('Table body element:', tbody.length ? 'found' : 'not found');

                    tbody.empty();
                    students.forEach(student => {
                        tbody.append(`
                            <tr>
                                <td>${student[0]}</td>
                                <td>${student[1]}</td>
                                <td>${student[2]}</td>
                            </tr>
                        `);
                    });
                })
                .fail(function(jqXHR, textStatus, errorThrown) {
                    console.error('AJAX request failed:', {
                        status: jqXHR.status,
                        statusText: jqXHR.statusText,
                        responseText: jqXHR.responseText,
                        textStatus: textStatus,
                        errorThrown: errorThrown
                    });
                });
        } catch (error) {
            console.error('Error in viewClassStudents:', error);
        }
    };

    window.updateClass = function() {
        const classId = $('#edit_class_id').val();
        const data = {
            name: $('#edit_class_name').val(),
            major_id: $('#edit_class_major').val(),
            counselor_id: $('#edit_class_counselor').val() || null
        };

        console.log('Updating class:', classId, 'with data:', data);

        $.ajax({
            url: `/api/admin/classes/${classId}`,
            method: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(response) {
                $('#editClassModal').modal('hide');
                showAlert('success', '更新班级成功');
                tables.classesTable.ajax.reload();
            },
            error: function(xhr) {
                showAlert('danger', '更新班级失败: ' + (xhr.responseJSON?.error || '未知错误'));
            }
        });
    };

    window.addClass = function() {
        const data = {
            name: $('#addClassForm [name="name"]').val(),
            majorId: $('#majorId').val(),
            counselorId: $('#counselorId').val() || null
        };

        console.log('Adding class with data:', data);

        $.ajax({
            url: '/api/admin/classes/add',
            method: 'POST',
            data: data,
            success: function(response) {
                $('#addClassModal').modal('hide');
                $('#addClassForm')[0].reset();
                showAlert('success', '添加班级成功');
                tables.classesTable.ajax.reload();
            },
            error: function(xhr) {
                showAlert('danger', '添加班级失败: ' + (xhr.responseJSON?.error || '未知错误'));
            }
        });
    };

    // 加载专业选项
    $.get('/api/admin/majors/list', function(majors) {
        const majorSelect = $('#majorId');
        majorSelect.empty();
        majorSelect.append('<option value="">选择专业...</option>');
        majors.forEach(major => {
            majorSelect.append(
                $('<option>')
                    .val(major[0])
                    .text(major[1])
            );
        });
    });

    // 加载辅导员选项
    $.get('/api/admin/counselors/list', function(counselors) {
        const counselorSelect = $('#counselorId');
        counselorSelect.empty();
        counselorSelect.append('<option value="">选择辅导员...</option>');
        counselors.forEach(counselor => {
            counselorSelect.append(
                $('<option>')
                    .val(counselor[0])
                    .text(counselor[1])
            );
        });
    });

    // 初始化报表
    initializeReports();

    window.editMajor = function(majorId) {
        console.log('Editing major:', majorId);

        $.get(`/api/admin/majors/${majorId}`, function(majorData) {
            console.log('Major data:', majorData);

            $('#edit_major_id').val(majorId);
            $('#edit_major_name').val(majorData.name);
            $('#edit_major_department').val(majorData.department);

            $('#editMajorModal').modal('show');
        });
    };

    window.deleteMajor = function(majorId) {
        if (confirm('确定要删除这个专业吗？')) {
            $.ajax({
                url: `/api/admin/majors/${majorId}`,
                method: 'DELETE',
                success: function() {
                    showAlert('success', '删除专业成功');
                    tables.majorsTable.ajax.reload();
                },
                error: function(xhr) {
                    showAlert('danger', '删除专业失败: ' + (xhr.responseJSON?.error || '未知错误'));
                }
            });
        }
    };

    window.addMajor = function() {
        const data = {
            name: $('#addMajorForm [name="name"]').val(),
            department: $('#addMajorForm [name="department"]').val()
        };

        console.log('Adding major with data:', data);

        $.ajax({
            url: '/api/admin/majors/add',
            method: 'POST',
            data: data,
            success: function(response) {
                $('#addMajorModal').modal('hide');
                $('#addMajorForm')[0].reset();
                showAlert('success', '添加专业成功');
                tables.majorsTable.ajax.reload();
            },
            error: function(xhr) {
                showAlert('danger', '添加专业失败: ' + (xhr.responseJSON?.error || '未知错误'));
            }
        });
    };

    window.updateMajor = function() {
        const majorId = $('#edit_major_id').val();
        const data = {
            name: $('#edit_major_name').val(),
            department: $('#edit_major_department').val()
        };

        console.log('Updating major:', majorId, 'with data:', data);

        $.ajax({
            url: `/api/admin/majors/${majorId}`,
            method: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(response) {
                $('#editMajorModal').modal('hide');
                showAlert('success', '更新专业成功');
                tables.majorsTable.ajax.reload();
            },
            error: function(xhr) {
                showAlert('danger', '更新专业失败: ' + (xhr.responseJSON?.error || '未知错误'));
            }
        });
    };

    window.editTeacher = function(teacherId) {
        console.log('Editing teacher:', teacherId);

        $.get(`/api/admin/teachers/${teacherId}`, function(teacherData) {
            console.log('Teacher data:', teacherData);

            $('#edit_teacher_id').val(teacherId);
            $('#edit_teacher_name').val(teacherData.name);
            $('#edit_teacher_title').val(teacherData.title);
            $('#edit_teacher_department').val(teacherData.department);

            $('#editTeacherModal').modal('show');
        });
    };

    window.deleteTeacher = function(teacherId) {
        if (confirm('确定要删除这个教师吗？')) {
            $.ajax({
                url: `/api/admin/teachers/${teacherId}`,
                method: 'DELETE',
                success: function() {
                    showAlert('success', '删除教师成功');
                    tables.teachersTable.ajax.reload();
                },
                error: function(xhr) {
                    showAlert('danger', '删除教师失败: ' + (xhr.responseJSON?.error || '未知错误'));
                }
            });
        }
    };

    window.addTeacher = function() {
        const formData = new FormData();
        formData.append('name', $('#addTeacherForm [name="name"]').val());
        formData.append('title', $('#addTeacherForm [name="title"]').val());
        formData.append('department', $('#addTeacherForm [name="department"]').val());

        console.log('Adding teacher with data:', {
            name: formData.get('name'),
            title: formData.get('title'),
            department: formData.get('department')
        });

        $.ajax({
            url: '/api/admin/teachers/add',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                $('#addTeacherModal').modal('hide');
                $('#addTeacherForm')[0].reset();
                showAlert('success', '添加教师成功');
                tables.teachersTable.ajax.reload();
            },
            error: function(xhr) {
                console.error('Error adding teacher:', xhr.responseText);
                showAlert('danger', '添加教师失败: ' + (xhr.responseJSON?.error || '未知错误'));
            }
        });
    };

    window.updateTeacher = function() {
        const teacherId = $('#edit_teacher_id').val();
        const data = {
            name: $('#edit_teacher_name').val(),
            title: $('#edit_teacher_title').val(),
            department: $('#edit_teacher_department').val()
        };

        console.log('Updating teacher:', teacherId, 'with data:', data);

        $.ajax({
            url: `/api/admin/teachers/${teacherId}`,
            method: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(response) {
                $('#editTeacherModal').modal('hide');
                showAlert('success', '更新教师成功');
                tables.teachersTable.ajax.reload();
            },
            error: function(xhr) {
                showAlert('danger', '更新教师失败: ' + (xhr.responseJSON?.error || '未知错误'));
            }
        });
    };

    window.editCourse = function(courseId) {
        console.log('Editing course:', courseId);

        $.get(`/api/admin/courses/${courseId}`, function(courseData) {
            console.log('Course data:', courseData);

            $('#edit_course_id').val(courseId);
            $('#edit_course_name').val(courseData.name);
            $('#edit_course_credits').val(courseData.credits);
            $('#edit_course_hours').val(courseData.hours);
            $('#edit_course_teacher').val(courseData.teacher_id);
            $('#edit_course_semester').val(courseData.semester_id);
            $('#edit_course_max_students').val(courseData.max_students);

            $('#editCourseModal').modal('show');
        });
    };

    window.deleteCourse = function(courseId) {
        if (confirm('确定要删除这个课程吗？')) {
            $.ajax({
                url: `/api/admin/courses/${courseId}`,
                method: 'DELETE',
                success: function() {
                    showAlert('success', '删除课程成功');
                    tables.coursesTable.ajax.reload();
                },
                error: function(xhr) {
                    showAlert('danger', '删除课程失败: ' + (xhr.responseJSON?.error || '未知错误'));
                }
            });
        }
    };

    window.addCourse = function() {
        const formData = new FormData();
        formData.append('name', $('#addCourseForm [name="name"]').val());
        formData.append('credits', $('#addCourseForm [name="credits"]').val());
        formData.append('hours', $('#addCourseForm [name="hours"]').val());
        formData.append('teacher_id', $('#addCourseForm [name="teacher_id"]').val());
        formData.append('semester_id', $('#addCourseForm [name="semester_id"]').val());
        formData.append('max_students', $('#addCourseForm [name="max_students"]').val());

        console.log('Adding course with data:', {
            name: formData.get('name'),
            credits: formData.get('credits'),
            hours: formData.get('hours'),
            teacher_id: formData.get('teacher_id'),
            semester_id: formData.get('semester_id'),
            max_students: formData.get('max_students')
        });

        $.ajax({
            url: '/api/admin/courses/add',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                $('#addCourseModal').modal('hide');
                $('#addCourseForm')[0].reset();
                showAlert('success', '添加课程成功');
                tables.coursesTable.ajax.reload();
            },
            error: function(xhr) {
                console.error('Error adding course:', xhr.responseText);
                showAlert('danger', '添加课程失败: ' + (xhr.responseJSON?.error || '未知错误'));
            }
        });
    };

    window.updateCourse = function() {
        const courseId = $('#edit_course_id').val();
        const data = {
            name: $('#edit_course_name').val(),
            credits: $('#edit_course_credits').val(),
            hours: $('#edit_course_hours').val(),
            teacher_id: $('#edit_course_teacher').val(),
            semester_id: $('#edit_course_semester').val(),
            max_students: $('#edit_course_max_students').val()
        };

        console.log('Updating course:', courseId, 'with data:', data);

        $.ajax({
            url: `/api/admin/courses/${courseId}`,
            method: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(response) {
                $('#editCourseModal').modal('hide');
                showAlert('success', '更新课程成功');
                tables.coursesTable.ajax.reload();
            },
            error: function(xhr) {
                showAlert('danger', '更新课程失败: ' + (xhr.responseJSON?.error || '未知错误'));
            }
        });
    };

    // 加载教师选项
    function loadTeacherOptions() {
        $.get('/api/admin/teachers/list', function(teachers) {
            const teacherSelects = $('#edit_course_teacher, #addCourseForm [name="teacher_id"]');
            teacherSelects.empty();
            teacherSelects.append('<option value="">选择教师...</option>');
            teachers.forEach(teacher => {
                teacherSelects.append(
                    $('<option>')
                        .val(teacher[0])  // teacher_id
                        .text(teacher[1])  // name
                );
            });
        });
    }

    // 加载学期选项
    function loadSemesterOptions() {
        $.get('/api/admin/semesters/list', function(semesters) {
            const semesterSelects = $('#edit_course_semester, #addCourseForm [name="semester_id"]');
            semesterSelects.empty();
            semesterSelects.append('<option value="">选择学期...</option>');
            semesters.forEach(semester => {
                semesterSelects.append(
                    $('<option>')
                        .val(semester.semester_id)
                        .text(semester.name)
                );
            });
        });
    }

    // 在模态框打开时加载选项
    $('#addCourseModal').on('show.bs.modal', function() {
        loadTeacherOptions();
        loadSemesterOptions();
    });

    $('#editCourseModal').on('show.bs.modal', function() {
        loadTeacherOptions();
        loadSemesterOptions();
    });

    // 学期管理相关函数
    window.editSemester = function(semesterId) {
        console.log('Editing semester:', semesterId);

        $.get(`/api/admin/semesters/${semesterId}`, function(semesterData) {
            console.log('Semester data:', semesterData);

            $('#edit_semester_id').val(semesterId);
            $('#edit_semester_name').val(semesterData.name);
            $('#edit_semester_start_date').val(semesterData.start_date);
            $('#edit_semester_end_date').val(semesterData.end_date);
            $('#edit_semester_status').prop('checked', semesterData.status === 1);

            $('#editSemesterModal').modal('show');
        });
    };

    window.deleteSemester = function(semesterId) {
        if (confirm('确定要删除这个学期吗？')) {
            $.ajax({
                url: `/api/admin/semesters/${semesterId}`,
                method: 'DELETE',
                success: function() {
                    showAlert('success', '删除学期成功');
                    tables.semestersTable.ajax.reload();
                },
                error: function(xhr) {
                    showAlert('danger', '删除学期失败: ' + (xhr.responseJSON?.error || '未知错误'));
                }
            });
        }
    };

    window.addSemester = function() {
        const formData = new FormData();
        formData.append('name', $('#addSemesterForm [name="name"]').val());
        formData.append('start_date', $('#addSemesterForm [name="start_date"]').val());
        formData.append('end_date', $('#addSemesterForm [name="end_date"]').val());
        formData.append('status', $('#addSemesterForm [name="status"]').prop('checked') ? 1 : 0);

        console.log('Adding semester with data:', {
            name: formData.get('name'),
            start_date: formData.get('start_date'),
            end_date: formData.get('end_date'),
            status: formData.get('status')
        });

        $.ajax({
            url: '/api/admin/semesters/add',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                $('#addSemesterModal').modal('hide');
                $('#addSemesterForm')[0].reset();
                showAlert('success', '添加学期成功');
                tables.semestersTable.ajax.reload();
            },
            error: function(xhr) {
                console.error('Error adding semester:', xhr.responseText);
                showAlert('danger', '添加学期失败: ' + (xhr.responseJSON?.error || '未知错误'));
            }
        });
    };

    window.updateSemester = function() {
        const semesterId = $('#edit_semester_id').val();
        const data = {
            name: $('#edit_semester_name').val(),
            start_date: $('#edit_semester_start_date').val(),
            end_date: $('#edit_semester_end_date').val(),
            status: $('#edit_semester_status').prop('checked') ? 1 : 0
        };

        console.log('Updating semester:', semesterId, 'with data:', data);

        $.ajax({
            url: `/api/admin/semesters/${semesterId}`,
            method: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(response) {
                $('#editSemesterModal').modal('hide');
                showAlert('success', '更新学期成功');
                tables.semestersTable.ajax.reload();
            },
            error: function(xhr) {
                showAlert('danger', '更新学期失败: ' + (xhr.responseJSON?.error || '未知错误'));
            }
        });
    };

    // 添加导出报表按钮的事件处理
    $('#exportTeacherWorkload').click(function() {
        window.location.href = '/api/admin/reports/export/teacher_workload';
    });

    $('#exportCourseSelection').click(function() {
        window.location.href = '/api/admin/reports/export/course_selection';
    });
});

// 辅助函数
function showAlert(type, message) {
    const alertDiv = $(`<div class="alert alert-${type} alert-dismissible fade show" role="alert">
        ${message}
        <button type="button" class="close" data-dismiss="alert">
            <span>&times;</span>
        </button>
    </div>`);

    $('.container').prepend(alertDiv);
    setTimeout(() => alertDiv.alert('close'), 3000);
}

// 报表初始化函数
function initializeReports() {
    // 加载教师工作量报表
    $.get('/api/admin/reports/teacher-workload', function(data) {
        new Chart($('#teacherWorkloadChart'), {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [{
                    label: '课程数',
                    data: data.courses,
                    backgroundColor: 'rgba(54, 162, 235, 0.5)'
                }, {
                    label: '学生数',
                    data: data.students,
                    backgroundColor: 'rgba(255, 99, 132, 0.5)'
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    });

    // 加载选课情况报表
    $.get('/api/admin/reports/course-selection', function(data) {
        new Chart($('#courseSelectionChart'), {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [{
                    label: '已选人数',
                    data: data.values,
                    backgroundColor: 'rgba(75, 192, 192, 0.5)'
                }, {
                    label: '最大人数',
                    data: data.max_students,
                    backgroundColor: 'rgba(153, 102, 255, 0.5)'
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    });
}
</script>
{% endblock %}